name: PR Checklist Validation

on:
  pull_request:
    types: [opened, edited, synchronize]

jobs:
  validate-pr-checklist:
    runs-on: ubuntu-latest
    steps:
      - name: Check Required PR Checklists
        run: |
          PR_BODY="${{ github.event.pull_request.body }}"
          PR_AUTHOR="${{ github.event.pull_request.user.login }}"

          JIRA_REGEX="https:\/\/te-collinsongroup\.atlassian\.net\/browse\/[A-Z0-9-]+"
          MISSING_CHECKS=""

          # Validate "Reason for Changes" field (must contain at least one letter)
          REASON_SECTION=$(echo "$PR_BODY" | awk '/Reason for Changes:/,/^$/' | tail -n +2)
          if [[ -z "$REASON_SECTION" || ! "$REASON_SECTION" =~ [a-zA-Z] ]]; then
            MISSING_CHECKS="$MISSING_CHECKS\n❌ **Missing or invalid:** *Reason for Changes* (must contain at least one letter)"
          fi

          # Validate "Developer" field (must contain at least one letter)
          DEVELOPER_SECTION=$(echo "$PR_BODY" | awk '/Developer:/,/^$/' | tail -n +2)
          if [[ -z "$DEVELOPER_SECTION" || ! "$DEVELOPER_SECTION" =~ [a-zA-Z] ]]; then
            MISSING_CHECKS="$MISSING_CHECKS\n❌ **Missing or invalid:** *Developer* (must contain at least one letter)"
          fi

          # Validate JIRA Ticket format
          JIRA_TICKET=$(echo "$PR_BODY" | grep -oE "$JIRA_REGEX")
          if [[ -z "$JIRA_TICKET" ]]; then
            MISSING_CHECKS="$MISSING_CHECKS\n❌ **Invalid or Missing:** *JIRA Ticket* (Must follow format: https://te-collinsongroup.atlassian.net/browse/PROJECT-123)"
          fi

          REQUIRED_CHECKLISTS=(
            "Required databases are available."
            "Required schemas are created through the data-platform repo."
            "Required source tables are available/updated."
            "Final DEV Testing: All tests passed, no unready changes present."
            "Schema Documentation: updated _schema.yml with correct schema, data types, PII tagging and descriptions."
            "This change is ready for further deployment in DEV, UAT & PROD."
            "Changes have been validated and look good in DEV/UAT."
          )

          # Check all required checklists
          for CHECK in "${REQUIRED_CHECKLISTS[@]}"; do
            if ! echo "$PR_BODY" | grep -q "\- \[[^[:space:]]\] $CHECK"; then
              MISSING_CHECKS="$MISSING_CHECKS\n❌ **Missing:** $CHECK"
            fi
          done

          if [[ -n "$MISSING_CHECKS" ]]; then
            echo "🚨 PR validation failed! Missing checklists detected."
            echo "PR_AUTHOR=${PR_AUTHOR}" >> $GITHUB_ENV
            echo "MISSING_CHECKS=${MISSING_CHECKS}" >> $GITHUB_ENV
            exit 1
          else
            echo "✅ All required checklists are marked."
          fi

      - name: Post Comment if Checklists Are Missing
        if: failure()
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const issue_number = context.payload.pull_request.number;
            const pr_author = process.env.PR_AUTHOR;
            const missing_checks = process.env.MISSING_CHECKS;

            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue_number,
              body: `@${pr_author} 🚨 **Your PR is missing required fields or checklist items!**\n${missing_checks}\n\nPlease update the PR description accordingly to meet the required criteria.`
            });
